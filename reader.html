<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="readerTitle">Book Reader - CLIQ BOOK</title>
    <meta name="description" content="Read your favorite books online with CLIQ BOOK's advanced reader interface.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF.js for PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root {
            --primary: #1a2332;
            --secondary: #f4a261;
            --background: #fefefe;
            --text: #2d3748;
            --success: #2d5a3d;
            --warning: #d69e2e;
        }
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        
        .reader-container {
            background: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
        }
        
        .reader-container.dark {
            background: #1a1a1a;
            color: #e2e8f0;
        }
        
        .reader-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .reader-header.dark {
            background: rgba(26, 26, 26, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .reader-controls {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .reader-controls.dark {
            background: rgba(45, 45, 45, 0.9);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .book-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            font-size: 18px;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .book-content.dark {
            background: #2d3748;
        }
        
        .page-controls {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 40;
        }
        
        .control-btn {
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .progress-bar {
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--secondary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .font-size-small { font-size: 16px; }
        .font-size-medium { font-size: 18px; }
        .font-size-large { font-size: 20px; }
        .font-size-xl { font-size: 22px; }
        
        .line-height-normal { line-height: 1.6; }
        .line-height-relaxed { line-height: 1.8; }
        .line-height-loose { line-height: 2.0; }
        
        .settings-panel {
            position: fixed;
            right: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 50;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-panel.dark {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        .bookmark-item {
            transition: all 0.2s ease;
        }
        
        .bookmark-item:hover {
            background: #f8fafc;
            transform: translateX(4px);
        }
        
        .bookmark-item.dark:hover {
            background: #4a5568;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .book-content {
                padding: 1rem;
                margin: 1rem;
                font-size: 16px;
            }
            
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .page-controls {
                bottom: 1rem;
            }
        }
    </style>
</head>
<body class="reader-container">
    <!-- Header -->
    <header class="reader-header fixed top-0 left-0 right-0 z-40 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="window.history.back()" 
                        class="control-btn p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>
                
                <div>
                    <h1 id="bookTitle" class="font-display font-bold text-lg">Loading book...</h1>
                    <p id="bookAuthor" class="text-sm opacity-75">by Unknown Author</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-2">
                <button onclick="toggleBookmarks()" 
                        class="control-btn p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                    </svg>
                </button>
                
                <button onclick="toggleSettings()" 
                        class="control-btn p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar mt-3">
            <div id="progressFill" class="progress-fill" style="width: 0%"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-32 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- Book Content -->
            <div id="bookContent" class="book-content fade-in">
                <div class="text-center py-12">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading book content...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Page Controls -->
    <div class="page-controls">
        <div class="reader-controls flex items-center space-x-4 px-6 py-3">
            <button id="prevPage" onclick="previousPage()" 
                    class="control-btn p-3 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50"
                    disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            
            <div class="flex items-center space-x-2">
                <span id="currentPage" class="font-semibold">1</span>
                <span class="text-gray-500">of</span>
                <span id="totalPages" class="text-gray-500">1</span>
            </div>
            
            <button id="nextPage" onclick="nextPage()" 
                    class="control-btn p-3 rounded-lg hover:bg-gray-100 transition-colors disabled:opacity-50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">Reading Settings</h3>
            <button onclick="toggleSettings()" 
                    class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="p-6 space-y-6">
            <!-- Theme Settings -->
            <div>
                <h4 class="font-semibold mb-3">Theme</h4>
                <div class="flex space-x-2">
                    <button onclick="setTheme('light')" 
                            class="theme-btn flex-1 py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                        ‚òÄÔ∏è Light
                    </button>
                    <button onclick="setTheme('dark')" 
                            class="theme-btn flex-1 py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                        üåô Dark
                    </button>
                </div>
            </div>
            
            <!-- Font Size -->
            <div>
                <h4 class="font-semibold mb-3">Font Size</h4>
                <div class="flex space-x-2">
                    <button onclick="setFontSize('small')" 
                            class="font-size-btn py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                        Aa
                    </button>
                    <button onclick="setFontSize('medium')" 
                            class="font-size-btn py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors text-lg">
                        Aa
                    </button>
                    <button onclick="setFontSize('large')" 
                            class="font-size-btn py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors text-xl">
                        Aa
                    </button>
                    <button onclick="setFontSize('xl')" 
                            class="font-size-btn py-2 px-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors text-2xl">
                        Aa
                    </button>
                </div>
            </div>
            
            <!-- Line Height -->
            <div>
                <h4 class="font-semibold mb-3">Line Spacing</h4>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="lineHeight" value="normal" 
                               class="mr-2 text-blue-600 focus:ring-blue-500" 
                               onchange="setLineHeight('normal')">
                        <span>Normal</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="lineHeight" value="relaxed" checked
                               class="mr-2 text-blue-600 focus:ring-blue-500" 
                               onchange="setLineHeight('relaxed')">
                        <span>Relaxed</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="lineHeight" value="loose"
                               class="mr-2 text-blue-600 focus:ring-blue-500" 
                               onchange="setLineHeight('loose')">
                        <span>Loose</span>
                    </label>
                </div>
            </div>
            
            <!-- Bookmarks -->
            <div>
                <h4 class="font-semibold mb-3">Bookmarks</h4>
                <div id="bookmarksList" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Bookmarks will be loaded here -->
                </div>
                <button onclick="addBookmark()" 
                        class="w-full mt-2 py-2 px-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    üìñ Bookmark Current Page
                </button>
            </div>
        </div>
    </div>

    <!-- Bookmarks Panel -->
    <div id="bookmarksPanel" class="settings-panel">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-lg font-bold">Bookmarks</h3>
            <button onclick="toggleBookmarks()" 
                    class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="p-6">
            <div id="allBookmarksList" class="space-y-2">
                <!-- All bookmarks will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script src="main.js"></script>
    
    <script>
        // Reader page specific functionality
        let currentBook = null;
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 1;

        let readingSettings = {
            theme: 'light',
            fontSize: 'medium',
            lineHeight: 'relaxed'
        };
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        function initReaderPage() {
            const params = new URLSearchParams(window.location.search);
            const bookId = params.get('book');
            
            if (!bookId) {
                window.location.href = 'library.html';
                return;
            }
            
            currentBook = AppState.books.find(book => book.id === bookId);
            
            if (!currentBook) {
                Utils.showNotification('Book not found', 'error');
                setTimeout(() => { window.location.href = 'library.html'; }, 2000);
                return;
            }
            
            if (!Membership.canAccessBook(currentBook)) {
                Utils.showNotification('You don\'t have access to this book', 'error');
                setTimeout(() => { window.location.href = 'book.html?id=' + bookId; }, 2000);
                return;
            }
            
            updateReaderUI();
            loadReadingSettings();
            loadBookContent();
            updateCurrentBookBookmarksListUI();
        }
        
        function loadBookContent() {
            const bookContent = document.getElementById('bookContent');
            if (currentBook && currentBook.fileUrl) {
                bookContent.innerHTML = '<div class="text-center py-12"><div class="loading-spinner mx-auto mb-4"></div><p class="text-gray-600">Loading PDF...</p></div>';
                
                const loadingTask = pdfjsLib.getDocument(currentBook.fileUrl);
                loadingTask.promise.then(function(pdf) {
                    pdfDoc = pdf;
                    totalPages = pdf.numPages;
                    updatePageControls();
                    renderPage(currentPage);
                }, function (reason) {
                    console.error(reason);
                    bookContent.innerHTML = '<div class="text-center py-12"><p class="text-red-500">Error loading PDF.</p></div>';
                });
            } else {
                 bookContent.innerHTML = `<div class="text-center py-12">
                    <h1 class="font-display text-4xl font-bold mb-4">${currentBook.title}</h1>
                    <p class="text-xl text-gray-600 mb-8">by ${currentBook.author}</p>
                    <p class="text-gray-500">No readable content available for this book.</p>
                    <p class="text-gray-500 mt-2">Try uploading a PDF file in the admin panel.</p>
                </div>`;
            }
        }

        function renderPage(num) {
            if (!pdfDoc) return;

            pdfDoc.getPage(num).then(function(page) {
                const bookContent = document.getElementById('bookContent');
                const viewport = page.getViewport({scale: 1.5});
                
                // Prepare canvas using PDF page dimensions
                const canvas = document.createElement('canvas');
                canvas.id = 'pdf-canvas';
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                const renderTask = page.render(renderContext);
                renderTask.promise.then(function () {
                    bookContent.innerHTML = '';
                    bookContent.appendChild(canvas);
                });
            });

            // Update page counters
            currentPage = num;
            updatePageControls();
            updateProgress();
            saveReadingProgress();
        }
        
        function updateReaderUI() {
            document.getElementById('bookTitle').textContent = currentBook.title;
            document.getElementById('bookAuthor').textContent = `by ${currentBook.author}`;
            document.getElementById('readerTitle').textContent = `${currentBook.title} - Reader - CLIQ BOOK`;
        }
        
        function updatePageControls() {
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages;
            
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }
        
        function updateProgress() {
            const progress = (currentPage / totalPages) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        function previousPage() {
            if (currentPage > 1) {
                renderPage(currentPage - 1);
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                renderPage(currentPage + 1);
            }
        }
        
        function saveReadingProgress() {
            if (!AppState.currentUser || !currentBook) return;
            
            const progress = {
                bookId: currentBook.id,
                currentPage: currentPage,
                totalPages: totalPages,
                progress: (currentPage / totalPages) * 100,
                lastRead: new Date().toISOString()
            };
            
            let readingHistory = AppState.currentUser.readingHistory || [];
            const existingIndex = readingHistory.findIndex(item => item.bookId === currentBook.id);
            
            if (existingIndex >= 0) {
                readingHistory[existingIndex] = progress;
            } else {
                readingHistory.push(progress);
            }
            
            AppState.currentUser.readingHistory = readingHistory;
            localStorage.setItem('cliqbook_user', JSON.stringify(AppState.currentUser));
        }
        
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
            document.getElementById('bookmarksPanel').classList.remove('open');
        }
        
        function toggleBookmarks() {
            const panel = document.getElementById('bookmarksPanel');
            panel.classList.toggle('open');
            document.getElementById('settingsPanel').classList.remove('open');
            if (panel.classList.contains('open')) {
                loadAllBookmarks();
            }
        }
        
        function setTheme(theme) {
            readingSettings.theme = theme;
            document.body.className = `reader-container ${theme === 'dark' ? 'dark' : ''}`;
            document.querySelector('.reader-header').classList.toggle('dark', theme === 'dark');
            document.querySelector('.reader-controls').classList.toggle('dark', theme === 'dark');
            document.getElementById('settingsPanel').classList.toggle('dark', theme === 'dark');
            document.getElementById('bookmarksPanel').classList.toggle('dark', theme === 'dark');
            saveReadingSettings();
            updateThemeButtons();
        }
        
        function setFontSize(size) {
            // Font size for PDF is controlled by canvas scaling, so this is for non-pdf content
            // We can leave this for other content or future text-based reader.
        }
        
        function setLineHeight(height) {
            // Line height is also not applicable for canvas-rendered PDF
        }
        
        function updateThemeButtons() {
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
            const activeBtn = document.querySelector(`[onclick="setTheme('${readingSettings.theme}')"]`);
            if (activeBtn) activeBtn.classList.add('bg-blue-600', 'text-white');
        }
        
        function addBookmark() {
            if (!AppState.currentUser) {
                Utils.showNotification('Please login to bookmark pages', 'error');
                return;
            }
            const bookmark = {
                id: Utils.generateId(), bookId: currentBook.id, bookTitle: currentBook.title,
                page: currentPage, totalPages: totalPages, date: new Date().toISOString(),
                note: `Page ${currentPage} of ${currentBook.title}`
            };
            AppState.currentUser.bookmarks.push(bookmark);
            localStorage.setItem('cliqbook_user', JSON.stringify(AppState.currentUser));
            updateBookmarksListUI();
            Utils.showNotification('Bookmark added!', 'success');
        }
        
        function updateCurrentBookBookmarksListUI() {
            const list = document.getElementById('bookmarksList');
            if (!list) return;
            const bookBookmarks = (AppState.currentUser?.bookmarks || []).filter(b => b.bookId === currentBook.id);
            list.innerHTML = bookBookmarks.length ? bookBookmarks.map(b => `
                <div class="bookmark-item p-2 rounded-lg cursor-pointer" onclick="goToBookmark('${b.id}')">
                    <div class="text-sm font-medium">${b.note}</div>
                    <div class="text-xs text-gray-500">${new Date(b.date).toLocaleDateString()}</div>
                </div>`).join('') : '<p class="text-gray-500 text-sm">No bookmarks for this book.</p>';
        }

        function loadAllBookmarks() {
            const list = document.getElementById('allBookmarksList');
             if (!list) return;
            const bookmarks = AppState.currentUser?.bookmarks || [];
            list.innerHTML = bookmarks.length ? bookmarks.map(b => `
                <div class="bookmark-item p-3 rounded-lg cursor-pointer" onclick="goToBookmark('${b.id}')">
                    <div class="font-medium">${b.bookTitle}</div>
                    <div class="text-sm">${b.note}</div>
                    <div class="text-xs text-gray-500">${new Date(b.date).toLocaleDateString()}</div>
                </div>`).join('') : '<p class="text-gray-500 text-sm">No bookmarks yet.</p>';
        }

        function updateBookmarksListUI() {
            updateCurrentBookBookmarksListUI();
            loadAllBookmarks();
        }
        
        function goToBookmark(bookmarkId) {
            const bookmark = (AppState.currentUser?.bookmarks || []).find(b => b.id === bookmarkId);
            if (bookmark) {
                if(bookmark.bookId === currentBook.id) {
                    renderPage(bookmark.page);
                } else {
                    window.location.href = `reader.html?book=${bookmark.bookId}`;
                    // Page will reload and init will handle it.
                }
                toggleBookmarks();
            }
        }
        
        function loadReadingSettings() {
            const saved = localStorage.getItem('cliqbook_reading_settings');
            if (saved) readingSettings = { ...readingSettings, ...JSON.parse(saved) };
            setTheme(readingSettings.theme);
        }
        
        function saveReadingSettings() {
            localStorage.setItem('cliqbook_reading_settings', JSON.stringify(readingSettings));
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') previousPage();
            if (e.key === 'ArrowRight') nextPage();
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initReaderPage, 100);
        });
        
        window.addEventListener('beforeunload', () => {
            saveReadingProgress();
        });
    </script>
</body>
</html>